# DanmakuRender-4 使用指南
本文档描述了使用DMR录制直播流、渲染弹幕和上传直播回放的操作方法。    

**目录：**      
[简介](#简介)     
[简易使用](#简易使用)      
[高阶使用](#高阶使用)      
[常见问题](#常见问题)      

更新日期：2023.8.10。     

## 简介     
**本程序的主要功能包括：**
- 可以录制纯净直播流和弹幕，并且支持在本地预览带弹幕直播流。
- 可以自动渲染弹幕到视频中，并且渲染速度快。
- 支持同时录制多个直播。    
- 支持录播自动上传至B站。

**程序的使用方法是：**      
新版本已经可以简单的通过复制和修改录制文件实现多个主播的录制。      
在`configs`文件夹里复制一份`example.yml`文件，并且重命名为`replay-<任务名称>.yml`，例如`replay-飞天狙.yml`。然后修改复制后的文件，每个依照此规则命名的文件都将作为一个录制任务加入录制队列。      

**程序的工作流程是：**      
先录制一段时间（默认一个小时）的直播，然后在录制下一小时直播时启动对这一小时直播的渲染。录制完成后可以同时得到直播回放和带弹幕的直播回放（分为两个视频，存放于两个不同的文件夹）。上传将在当场直播结束（也就是主播下播之后）开始，上传到B站时会将同一场直播的视频放在同一个视频的不同分P下。        

## 简易使用     
在`configs`文件夹里复制一份`example.yml`文件，并且重命名为`replay-<任务名称>.yml`，例如`replay-飞天狙.yml`。然后修改复制后的文件，每个依照此规则命名的文件都将作为一个录制任务加入录制队列。      

运行时在程序目录打开控制台（win10系统shift+右键点击页面空白处，在菜单中选择“在此处打开powershell窗口”，win11在页面右键选择“在终端中打开”），输入`python main.py`执行程序。        
如果你已经可以正常运行程序了，那么也可以直接双击打开`main.py`文件运行。

**请注意：使用新方法指定录制配置请保证原有`replay.yml`中的replay项为空。**
- 关键字替换说明      

在一些配置选项中可能会说可用关键字替换，录制文件名称中的`{}`表示在程序运行的过程中自动替换为相应的内容，例如`{YEAR}年{MONTH}月{DAY}日`在运行时会被动态替换为`2023年8月10日`，具体可用关键字如下：     

| 关键字   | 注释  |
| :-------: | :-------: | 
| {STREAMER} |   主播名称   |  
| {TITLE} |   直播标题   | 
| {URL} |   直播间链接   | 
| {HAS_DANMU} | `带弹幕版`这几个字   | 
| {YEAR} |  年   | 
| {MONTH} | 月   | 
| {DAY} | 日   | 
| {HOUR} | 时   |
| {MINUTE} | 分 |
| {SECOND} | 秒 |
| {TASKNAME} | 任务名称，就是配置文件名称里面那个 |   

- 配置弹幕渲染参数（**非N卡用户必读！**）       
非N卡用户需要在`replay.yml`里面修改渲染弹幕的参数，具体描述如下：
```yaml
render: 
  # 硬件解码参数，默认自动，如果是CPU编码记得改为空
  hwaccel_args: [-hwaccel,auto] 
  # 使用NVIDIA H.264编码器，A卡用户设置为h264_amf，CPU渲染设置为libx264
  vencoder: h264_nvenc   
  # 指定编码器参数，默认15M码率         
  vencoder_args: ['-b:v','15M'] 
  # 输出重缩放，默认为空，可以设置为3840x2160绕过B站码率限制
  output_resize: ~
```
**关于硬件加速**：使用硬件加速编码遇到渲染失败问题，首先检查显卡驱动有没有更新！    

**关于输出重缩放**：很多人发现视频上传B站之后变糊（尤其是带弹幕的视频），但是本地看又很清晰，主要原因是B站现在对视频的码率做了限制，普通1080P视频码率一般不超过2Mbps(AV1编码)，只有直播的五分之一。   
为了绕过这个限制，需要使用伪4K的功能，简单地说就是把视频缩放到4K（3840x2160），让B站以为是4K视频然后按4K分配码率，这样一般能够分到15M的码率，最后看的时候就会很清晰。     

- 注意事项      

1. 如果遇到渲染失败，可以使用`render_only.py`进行渲染操作，渲染的配置将会由`replay.yml`决定。     
2. 设置好配置文件后，可以运行`dryrun.py`进行测试，程序将录制三段一分钟的视频，并根据配置文件渲染和上传（**这里的上传会自动设置延迟24小时发布，记得24小时内去B站稿件管理删除**），录制完成后可以自行检查效果。

## 高阶使用     
本节介绍配置文件可用的全部选项和功能。一般情况下简易使用已经可以满足90%以上需求。

